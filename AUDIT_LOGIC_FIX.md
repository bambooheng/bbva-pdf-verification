# 审核逻辑执行修复说明

## 问题描述

`MSTAR_BBVA_DTL_ANAL_FAST_IO`规则审核时没有按照`bbva_llm_rules_verification.xlsx`中的审核逻辑来判断。

## 根本原因

虽然系统从Excel中正确提取了审核逻辑字段（`condition_logic`、`validation_rule`、`decision_result`），但在prompt中：
1. **强调不够明确**：这些字段虽然被包含在prompt中，但没有明确强调必须严格按照这些逻辑执行
2. **任务描述过于通用**：prompt中的"必须完成的任务"部分过于通用，没有明确要求按照Excel中的审核逻辑执行
3. **缺少执行步骤说明**：没有要求LLM在evidence中说明如何按照审核逻辑执行的

## 修复方案

### 1. 添加明确的审核逻辑强调

在prompt中添加专门的章节，明确强调必须严格按照审核逻辑执行：

```python
## ⚠️ 重要：必须严格按照以下审核逻辑执行

**判断逻辑（必须严格执行）**：
{condition_logic}

**校验规则（必须严格执行）**：
{validation_rule}

**决策结果（必须严格执行）**：
{decision_result}

**执行要求**：
- 必须严格按照上述"判断逻辑"中的步骤执行，不得跳过任何步骤
- 必须严格按照"校验规则"进行比较和判断
- 必须严格按照"决策结果"的逻辑输出结果
- 如果上述逻辑中有明确的步骤说明，必须逐条执行，不得自行简化或修改
```

### 2. 改进任务描述

在"必须完成的任务"部分，将按照审核逻辑执行放在最前面：

```python
## 必须完成的任务

1. **严格按照"判断逻辑"执行**：必须按照上述"判断逻辑"中的步骤逐条执行，不得跳过或修改任何步骤。
2. **严格按照"校验规则"执行**：必须按照上述"校验规则"进行比较和判断，不得自行简化。
3. **严格按照"决策结果"执行**：必须按照上述"决策结果"的逻辑输出结果。
...
```

### 3. 要求说明执行过程

在任务描述中添加要求，要求LLM在evidence中说明如何按照审核逻辑执行的：

```python
12. **在evidence中必须明确说明：你是如何按照"判断逻辑"和"校验规则"执行的，每一步的执行结果是什么。**
```

### 4. 增强自检要求

在"输出前自检"部分，添加对审核逻辑执行的检查：

```python
## 输出前自检

- 是否严格按照"判断逻辑"中的步骤执行？
- 是否严格按照"校验规则"进行比较和判断？
- 是否严格按照"决策结果"的逻辑输出结果？
- **是否在evidence中明确说明了如何按照"判断逻辑"和"校验规则"执行的？**
...
```

## 修复效果

### 修复前

- 审核逻辑字段虽然被包含在prompt中，但强调不够
- LLM可能按照自己的理解执行，而不是严格按照Excel中的逻辑
- 无法验证LLM是否按照审核逻辑执行

### 修复后

- 审核逻辑被明确强调，放在prompt的显著位置
- 要求LLM必须严格按照审核逻辑执行，不得跳过或修改
- 要求LLM在evidence中说明执行过程，便于验证
- 在自检中增加了对审核逻辑执行的检查

## 使用示例

### Excel中的审核逻辑

假设Excel中有以下内容：

**判断逻辑**：
```
步骤1：从inputs的.json文件中获取页面1和页面2的layout_elements的content内容，并从中模糊匹配包含"Periodo"的信息以提取日期区间。
步骤2：从"Detalle de Movimientos Realizados"中提取所有OPER和LIQ日期，计算最小日期(min_date)和最大日期(max_date)。
```

**校验规则**：
```
判断min_date和max_date是否在步骤1提取的日期区间内。
```

**决策结果**：
```
如果min_date和max_date都在日期区间内，输出"一致"；否则输出"不一致"。
```

### 修复后的Prompt

修复后，prompt会明确强调：

```
## ⚠️ 重要：必须严格按照以下审核逻辑执行

**判断逻辑（必须严格执行）**：
步骤1：从inputs的.json文件中获取页面1和页面2的layout_elements的content内容，并从中模糊匹配包含"Periodo"的信息以提取日期区间。
步骤2：从"Detalle de Movimientos Realizados"中提取所有OPER和LIQ日期，计算最小日期(min_date)和最大日期(max_date)。

**校验规则（必须严格执行）**：
判断min_date和max_date是否在步骤1提取的日期区间内。

**决策结果（必须严格执行）**：
如果min_date和max_date都在日期区间内，输出"一致"；否则输出"不一致"。

**执行要求**：
- 必须严格按照上述"判断逻辑"中的步骤执行，不得跳过任何步骤
- 必须严格按照"校验规则"进行比较和判断
- 必须严格按照"决策结果"的逻辑输出结果
- 如果上述逻辑中有明确的步骤说明，必须逐条执行，不得自行简化或修改
```

## 注意事项

1. **Excel格式**：确保Excel中的审核逻辑字段（`condition_logic`、`validation_rule`、`decision_result`）填写完整
2. **逻辑清晰**：Excel中的审核逻辑应该清晰明确，便于LLM理解和执行
3. **验证evidence**：检查LLM返回的evidence，确认是否按照审核逻辑执行

## 更新日志

- **2024-01-XX**：添加明确的审核逻辑强调章节
- **2024-01-XX**：改进任务描述，将按照审核逻辑执行放在最前面
- **2024-01-XX**：要求LLM在evidence中说明执行过程
- **2024-01-XX**：增强自检要求，添加对审核逻辑执行的检查





