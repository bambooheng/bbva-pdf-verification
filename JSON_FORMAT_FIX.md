# JSON格式解析问题修复说明

## 问题描述

`MSTAR_BBVA_DTL_AMT_SINGLE`规则返回结果：
- **判断依据**：无法完整解析LLM响应，但从文本中提取到部分信息。原始响应已记录在日志中。
- **补充说明**：LLM响应格式异常，无法解析为JSON。已尝试从文本中提取关键信息。建议检查日志获取完整响应。

## 根本原因

1. **LLM响应格式不稳定**：即使要求JSON格式，LLM可能返回：
   - 包含Markdown代码块的响应（`` ```json ... ``` ``）
   - 包含额外说明文字的响应
   - 格式错误的JSON（单引号、尾随逗号、Python风格的True/False等）

2. **Prompt强调不够**：虽然要求JSON格式，但强调不够明确

3. **API参数问题**：`response_format`参数可能不被所有API支持，导致API调用失败

## 修复方案

### 1. 改进Prompt，更明确要求JSON格式

**修改前**：
```
## 输出格式（只允许以下 JSON）
要求：
- 不能输出 JSON 以外的任何内容（无说明、无 Markdown、无 ```）。
```

**修改后**：
```
## 输出格式（⚠️ 严格要求：只允许以下 JSON 格式）

**你必须严格按照以下格式输出，不要添加任何其他内容：**

**⚠️ 重要要求（必须严格遵守）：**
1. **只能输出JSON格式**：不能输出任何JSON以外的内容（无说明、无Markdown、无代码块标记、无```json```、无```等）。
2. **直接输出JSON对象**：直接输出 `{{"hit": ..., "evidence": ..., "confidence": ..., "notes": ...}}`，不要用代码块包裹。
3. **不要添加任何前缀或后缀**：不要在JSON前后添加任何文字说明、解释或标记。
...
```

### 2. 移除可能不支持的API参数

**修改**：移除了`response_format`参数，因为某些API（如DeepSeek）可能不支持此参数

```python
# 修改前
"response_format": {"type": "json_object"}  # 强制要求JSON格式输出

# 修改后
# 注意：某些API（如DeepSeek）可能不支持response_format参数
# 如果API返回错误，会在调用时自动处理
# "response_format": {"type": "json_object"}  # 暂时禁用，避免API不支持导致错误
```

### 3. 增强JSON解析和修复逻辑

添加了多种JSON修复方法：

**修复1：移除尾随逗号**
```python
json_text_cleaned = re.sub(r',\s*}', '}', json_text_cleaned)
json_text_cleaned = re.sub(r',\s*]', ']', json_text_cleaned)
```

**修复2：修复单引号为双引号**
```python
# 键名: 'key': -> "key":
# 字符串值: 'value' -> "value"
```

**修复3：修复Python风格为JSON风格**
```python
True -> true
False -> false
None -> null
```

**修复4：修复未转义的换行符**
```python
# 将字符串中的实际换行符转义为\n
```

**多级解析尝试**：
1. 尝试解析清理后的JSON
2. 如果失败，尝试解析原始JSON
3. 如果仍然失败，尝试更激进的修复
4. 记录所有错误信息

### 4. 改进System Message

在system message中明确要求JSON格式：

```python
{"role": "system", "content": "你是一个专业的银行审计系统，擅长分析银行流水数据并执行合规性检查。你必须严格按照要求返回JSON格式，不要添加任何其他内容。"}
```

## 修复效果

### 修复前

- LLM可能返回包含Markdown代码块的响应
- JSON解析失败，只能从文本中提取部分信息
- 返回的结果不完整（hit=null或部分信息）

### 修复后

- Prompt更明确地要求JSON格式
- 多种JSON修复方法，能够处理更多格式错误
- 即使解析失败，也会记录详细的错误信息
- 多级解析尝试，提高成功率

## 使用建议

### 如果仍然遇到JSON解析问题

1. **检查日志**：
   - 查看`logs/app.log`获取完整的LLM响应
   - 查看"原始响应前2000字符"和"提取的JSON文本"

2. **检查Prompt**：
   - 确认prompt中明确要求JSON格式
   - 确认没有其他要求导致LLM返回非JSON格式

3. **检查API响应**：
   - 确认API调用成功
   - 确认返回的响应内容

### 调试步骤

1. 查看日志中的"原始响应前2000字符"
2. 查看"提取的JSON文本"
3. 查看"清理后的JSON文本"
4. 查看"所有解析错误"

根据这些信息，可以：
- 了解LLM实际返回了什么
- 了解JSON提取是否成功
- 了解JSON修复是否有效
- 了解最终的解析错误

## 技术细节

### JSON修复优先级

1. **清理阶段**：移除尾随逗号、修复引号、修复True/False/None
2. **解析尝试1**：解析清理后的JSON
3. **解析尝试2**：解析原始JSON
4. **解析尝试3**：更激进的修复（修复换行符等）
5. **最后手段**：从文本中提取关键信息

### 错误处理

- 记录所有解析错误
- 记录原始响应（前2000字符）
- 记录提取的JSON文本
- 记录清理后的JSON文本

## 更新日志

- **2024-01-XX**：改进prompt，更明确要求JSON格式
- **2024-01-XX**：移除可能不支持的response_format参数
- **2024-01-XX**：增强JSON解析和修复逻辑
- **2024-01-XX**：添加多级解析尝试和详细错误记录





